services:
  db:
    build:
      context: ./database
      dockerfile: Dockerfile.windows
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${DB_PASSWORD}
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - mssql_data:C:\var\opt\mssql
    healthcheck:
      # Sintaxis de escape para variables en CMD de Windows
      test: ["CMD", "sqlcmd", "-S", "localhost", "-U", "sa", "-P", "%MSSQL_SA_PASSWORD%", "-Q", "SELECT 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  backend:
    build:
      context: .
      dockerfile: dockerfile.windows
    volumes:
      - .:C:\app
    ports:
      - "8000:8000"
    environment:
      - SECRET_KEY=insecure-dev-key
      - DEBUG=1
      - DB_ENGINE=mssql
      - DB_NAME=texcore_db
      - DB_USER=sa
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=db
      - DB_PORT=1433
      - DB_DRIVER=ODBC Driver 18 for SQL Server
    depends_on:
      db:
        condition: service_healthy

volumes:
  mssql_data: