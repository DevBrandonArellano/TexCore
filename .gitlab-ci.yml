stages:
  - build
  - test
  - deploy
  - health-check
  - rollback

variables:
  DOCKER_IMAGE_BACKEND: $CI_REGISTRY_IMAGE/backend
  DOCKER_IMAGE_NGINX: $CI_REGISTRY_IMAGE/nginx
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - frontend/node_modules/

# --- BUILD STAGE ---
build:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Build Backend
    - docker build -t $DOCKER_IMAGE_BACKEND:$CI_COMMIT_SHA -f Dockerfile.prod .
    - docker push $DOCKER_IMAGE_BACKEND:$CI_COMMIT_SHA
    # Build Nginx
    - docker build -t $DOCKER_IMAGE_NGINX:$CI_COMMIT_SHA -f nginx/Dockerfile .
    - docker push $DOCKER_IMAGE_NGINX:$CI_COMMIT_SHA
  only:
    - main
    - fixgitlab

# --- TEST STAGE ---
test_backend:
  stage: test
  image: python:3.12-slim
  before_script:
    - pip install -r requirements.txt
  script:
    - echo "Running backend tests..."
    - python manage.py test gestion inventory
  only:
    - main
    - fixgitlab

test_frontend:
  stage: test
  image: node:18-alpine
  script:
    - echo "Running frontend tests..."
    - cd frontend
    - npm install
    - npm test -- --watchAll=false
  only:
    - main
    - fixgitlab

# --- DEPLOY STAGE ---
deploy:
  stage: deploy
  tags:
    - production  # Targeted at your on-premise runner
  script:
    - echo "Deploying version $CI_COMMIT_SHA to on-premise server..."
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    
    # Tagging current 'latest' deployment as backup
    - docker tag $DOCKER_IMAGE_BACKEND:latest $DOCKER_IMAGE_BACKEND:backup || true
    - docker tag $DOCKER_IMAGE_NGINX:latest $DOCKER_IMAGE_NGINX:backup || true

    # Pull new images
    - docker pull $DOCKER_IMAGE_BACKEND:$CI_COMMIT_SHA
    - docker pull $DOCKER_IMAGE_NGINX:$CI_COMMIT_SHA

    # Deploy with new tag
    - export TAG=$CI_COMMIT_SHA
    - docker compose -f docker-compose.prod.yml up -d
    
    # Tag new deployment as 'latest'
    - docker tag $DOCKER_IMAGE_BACKEND:$CI_COMMIT_SHA $DOCKER_IMAGE_BACKEND:latest
    - docker tag $DOCKER_IMAGE_NGINX:$CI_COMMIT_SHA $DOCKER_IMAGE_NGINX:latest
  only:
    - main

# --- HEALTH-CHECK STAGE ---
health_check:
  stage: health-check
  image: curlimages/curl
  script:
    - echo "Waiting for service to stabilize..."
    - sleep 30
    - echo "Checking health..."
    # Local health check (adjust IP if needed, or use service name if internally accessible)
    - curl -f http://localhost/ || exit 1
  only:
    - main
  dependencies:
    - deploy

# --- ROLLBACK STAGE ---
rollback:
  stage: rollback
  tags:
    - production
  when: manual
  script:
    - echo "Rolling back to 'backup' tag..."
    - export TAG=backup
    - docker compose -f docker-compose.prod.yml up -d
  only:
    - main
